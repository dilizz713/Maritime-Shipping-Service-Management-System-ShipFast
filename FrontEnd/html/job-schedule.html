<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Job Schedule</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="p-4">

<div class="container">
    <h2 class="mb-4"><i class="bi bi-calendar-check"></i> Job Schedules</h2>

    <table class="table table-bordered table-hover" id="jobScheduleTable">
        <thead>
        <tr>
            <th>#</th>
            <th>Job Ref</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Vessel</th>
            <th>Service</th>
            <th>Port</th>
            <th>Original PO</th>
            <th>Matched PO</th>
            <th>Status</th>
            <th>Employee</th>
            <th>Remark</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Edit Job Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editScheduleModalLabel">Edit Job Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editScheduleId" />
                <div class="mb-3">
                    <label class="form-label">Original PO</label>
                    <input type="number" step="0.01" class="form-control" id="editOriginalPO" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Matched PO</label>
                    <input type="number" step="0.01" class="form-control" id="editMatchedPO" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Remark</label>
                    <textarea class="form-control" id="editRemark"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editStatus">
                        <option value="PENDING">Pending</option>
                        <option value="IN_PROGRESS">In Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="updateJobSchedule()">
                    <i class="bi bi-save"></i> Save
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<script src="../lib/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        loadJobSchedules();

    });


    function loadJobSchedules() {
        $.get("http://localhost:8080/api/v1/job-schedule/getAll", function (res) {
            const tbody = $("#jobScheduleTable tbody").empty();

            if (!res || !res.data || res.data.length === 0) {
                tbody.append('<tr><td colspan="12" class="text-center">No schedules found</td></tr>');
                return;
            }

            res.data.forEach((schedule, i) => {
                tbody.append(`
                        <tr>
                            <td>${i + 1}</td>
                            <td>${schedule.jobReference}</td>
                            <td>${new Date(schedule.jobDate).toLocaleDateString()}</td>
                            <td>${schedule.customerName}</td>
                            <td>${schedule.vesselName}</td>
                            <td>${schedule.serviceName}</td>
                            <td>${schedule.portName}</td>
                            <td>${schedule.originalPO ?? '-'}</td>
                            <td>${schedule.matchedPO ?? '-'}</td>
                            <td>${schedule.status}</td>
                            <td>${schedule.employeeName}</td>
                            <td>${schedule.remark ?? '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="openEditModal(${schedule.id})">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </td>
                        </tr>
                    `);
            });
        }).fail(function (err) {
            console.error(err);
            alert("Failed to load job schedules");
        });
    }

    function openEditModal(scheduleId) {
        $.get(`http://localhost:8080/api/v1/job-schedule/get/${scheduleId}`, function(schedule) {
            $("#editScheduleId").val(schedule.id);
            $("#editOriginalPO").val(schedule.originalPO);
            $("#editMatchedPO").val(schedule.matchedPO);
            $("#editRemark").val(schedule.remark || "");
            $("#editStatus").val(schedule.status);

            new bootstrap.Modal(document.getElementById('editScheduleModal')).show();
        }).fail(function() {
            alert("Failed to load job schedule data");
        });
    }

    // Update job schedule
    function updateJobSchedule() {
        const scheduleId = $("#editScheduleId").val();
        const dto = {
            originalPO: parseFloat($("#editOriginalPO").val()),
            matchedPO: parseFloat($("#editMatchedPO").val()),
            remark: $("#editRemark").val(),
            status: $("#editStatus").val()
        };

        $.ajax({
            url: `http://localhost:8080/api/v1/job-schedule/update/${scheduleId}`,
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(dto),
            success: function(res) {
                alert(res.message || "Updated successfully!");
                $("#editScheduleModal").modal('hide');
                loadJobSchedules(); // reload table after update
            },
            error: function(err) {
                console.error(err);
                alert("Failed to update job schedule");
            }
        });
    }
</script>
</body>
</html>
