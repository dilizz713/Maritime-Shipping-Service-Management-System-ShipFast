<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meeting Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body { background: #f8f9fa; font-family: 'Poppins', sans-serif; }
        #video-container {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .video-card {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            aspect-ratio: 4/3; /* Maintains video aspect ratio */
        }
        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-controls {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 25px;
            z-index: 10;
        }
        .video-controls i { color: white; font-size: 1.2rem; cursor: pointer; }
        .video-controls i:hover { color: #0d6efd; }
        .video-name {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
        }
        #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="text-center mb-4">Meeting Room</h3>
    <div class="row mb-3">
        <div class="col-md-8">
            <input type="text" id="meetingCode" class="form-control mb-2" placeholder="Enter Meeting Code">
        </div>
        <div class="col-md-4">
            <button id="joinBtn" class="btn btn-primary w-100">Join Meeting</button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div id="video-container"></div>
        </div>
        <div class="col-md-4">
            <h5>Chat</h5>
            <div id="chat-box"></div>
            <div class="input-group mt-2">
                <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." />
                <button class="btn btn-primary" id="sendChat">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    let localStream;
    let peers = {};
    let ws;
    const username = "Employee_" + Math.floor(Math.random()*1000);
    let meetingCode = "";

    function addVideoCard(id, stream=null, muted=false){
        if(document.getElementById(id)) return;

        const container = document.createElement("div");
        container.className = "video-card";
        container.id = id;

        const video = document.createElement("video");
        if(stream) video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;
        video.muted = muted;
        video.onclick = () => video.requestFullscreen();

        const nameLabel = document.createElement("div");
        nameLabel.className = "video-name";
        nameLabel.innerText = id;

        const controls = document.createElement("div");
        controls.className = "video-controls";

        const btnVideo = document.createElement("i");
        btnVideo.className = stream && stream.getVideoTracks()[0].enabled ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill text-danger";
        btnVideo.title = "Toggle Video";
        btnVideo.onclick = () => toggleVideo(id, btnVideo, video, nameLabel, stream);

        const btnAudio = document.createElement("i");
        btnAudio.className = stream && stream.getAudioTracks()[0].enabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill text-danger";
        btnAudio.title = "Toggle Audio";
        btnAudio.onclick = () => toggleAudio(id, btnAudio, stream);

        const btnFull = document.createElement("i");
        btnFull.className = "bi bi-arrows-fullscreen";
        btnFull.title = "Fullscreen";
        btnFull.onclick = () => container.requestFullscreen();

        const btnLeave = document.createElement("i");
        btnLeave.className = "bi bi-telephone-x-fill text-danger";
        btnLeave.title = "Leave Meeting";
        btnLeave.onclick = () => leaveMeeting(id);

        controls.appendChild(btnVideo);
        controls.appendChild(btnAudio);
        controls.appendChild(btnFull);
        controls.appendChild(btnLeave);

        container.appendChild(video);
        container.appendChild(nameLabel);
        container.appendChild(controls);
        document.getElementById("video-container").appendChild(container);

        updateVideoVisibility(id, stream, video, nameLabel);
    }

    // Show name if video off
    function updateVideoVisibility(id, stream, video, nameLabel){
        if(stream && stream.getVideoTracks()[0].enabled){
            video.style.display = "block";
            nameLabel.style.display = "none";
        } else {
            video.style.display = "none";
            nameLabel.style.display = "block";
        }
    }

    // Init local media
    async function initMedia(){
        try {
            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            addVideoCard(username, localStream, true);
        } catch(err){
            alert("Error accessing camera/microphone: "+err);
        }
    }

    // Toggle video
    function toggleVideo(id, btn, video, nameLabel, stream){
        if(id === username && stream){
            const track = stream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            btn.className = track.enabled ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill text-danger";
            updateVideoVisibility(id, stream, video, nameLabel);
        }
    }

    // Toggle audio
    function toggleAudio(id, btn, stream){
        if(id === username && stream){
            const track = stream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            btn.className = track.enabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill text-danger";
        }
    }

    // Leave meeting
    function leaveMeeting(id){
        if(id === username){
            if(ws) ws.send(JSON.stringify({type:"leave", meetingCode, fromId:username}));
            Object.values(peers).forEach(pc => pc.close());
            peers = {};
            document.getElementById("video-container").innerHTML = "";
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            localStream = null;
            alert("You have left the meeting.");
        } else {
            const card = document.getElementById(id);
            card?.remove();
            if(peers[id]) peers[id].close();
            delete peers[id];
        }
    }

    // Chat
    function addChatMessage(name, msg){
        const p = document.createElement("p");
        p.innerHTML = `<b>${name}:</b> ${msg}`;
        const chatBox = document.getElementById("chat-box");
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Join meeting
    document.getElementById("joinBtn").addEventListener("click", async ()=>{
        meetingCode = document.getElementById("meetingCode").value.trim();
        if(!meetingCode) return alert("Enter meeting code");

        ws = new WebSocket("ws://localhost:8080/ws/signaling");
        ws.onopen = ()=> ws.send(JSON.stringify({type:"join", meetingCode, fromId:username}));

        ws.onmessage = async (msg)=>{
            const data = JSON.parse(msg.data);
            const from = data.fromId;
            const type = data.type;

            if(type==="offer" && from!==username){
                const pc = createPeerConnection(from);
                await pc.setRemoteDescription(new RTCSessionDescription(data.payload));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({type:"answer", meetingCode, fromId:username, toId:from, payload:answer}));
            } else if(type==="answer" && data.toId===username){
                await peers[from].setRemoteDescription(new RTCSessionDescription(data.payload));
            } else if(type==="ice" && from!==username){
                await peers[from].addIceCandidate(data.payload);
            } else if(type==="chat"){
                addChatMessage(data.employeeName||from, data.message);
            }
        };

        await initMedia();
    });

    // Peer connection
    function createPeerConnection(peerId){
        const pc = new RTCPeerConnection();
        peers[peerId] = pc;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.onicecandidate = e=>{
            if(e.candidate){
                ws.send(JSON.stringify({type:"ice", meetingCode, fromId:username, toId:peerId, payload:e.candidate}));
            }
        };

        pc.ontrack = e=>{
            addVideoCard(peerId, e.streams[0]);
        };

        pc.onnegotiationneeded = async ()=>{
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({type:"offer", meetingCode, fromId:username, payload:offer}));
        };

        return pc;
    }

    // Send chat
    document.getElementById("sendChat").addEventListener("click", ()=>{
        const msg = document.getElementById("chatInput").value.trim();
        if(msg && ws){
            ws.send(JSON.stringify({type:"chat", meetingCode, fromId:username, employeeName:username, message:msg}));
            addChatMessage("Me", msg);
            document.getElementById("chatInput").value = "";
        }
    });
</script>
</body>
</html>
