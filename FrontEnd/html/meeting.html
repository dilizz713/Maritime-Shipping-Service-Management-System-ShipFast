<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meeting Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body { background: #f8f9fa; font-family: 'Poppins', sans-serif; }
        #video-container {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .video-card {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            aspect-ratio: 4/3;
        }
        .video-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-controls {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 25px;
            z-index: 10;
        }
        .video-controls i { color: white; font-size: 1.2rem; cursor: pointer; }
        .video-controls i:hover { color: #0d6efd; }
        .video-name {
            position: absolute;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
        }
        #chat-box { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="text-center mb-4">Meeting Room</h3>

    <!-- Pre-join settings -->
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" id="meetingCode" class="form-control mb-2" placeholder="Enter Meeting Code">
        </div>
        <div class="col-md-4">
            <input type="text" id="userName" class="form-control mb-2" placeholder="Enter Your Name">
        </div>
        <div class="col-md-4">
            <button id="joinBtn" class="btn btn-primary w-100">Join Meeting</button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="videoOn" checked>
                <label class="form-check-label" for="videoOn">Video On</label>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="audioOn" checked>
                <label class="form-check-label" for="audioOn">Audio On</label>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div id="video-container"></div>
        </div>
        <div class="col-md-4">
            <h5>Chat</h5>
            <div id="chat-box"></div>
            <div class="input-group mt-2">
                <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." />
                <button class="btn btn-primary" id="sendChat">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        let localStream;
        let peers = {};
        let ws;
        let username = "";
        let meetingCode = "";

        function addVideoCard(id, stream=null, muted=false){
            if($("#" + id).length) return;

            const $container = $("<div>", {class:"video-card", id:id});
            const $video = $("<video>", {autoplay:true, playsinline:true, muted:muted});
            if(stream) $video[0].srcObject = stream;
            $video.click(()=> $video[0].requestFullscreen());

            const $nameLabel = $("<div>", {class:"video-name", text:id});

            const $controls = $("<div>", {class:"video-controls"});
            const $btnVideo = $("<i>", {
                class: stream && stream.getVideoTracks()[0] && stream.getVideoTracks()[0].enabled
                    ? "bi bi-camera-video-fill" : "bi bi-camera-video-off-fill text-danger",
                title:"Toggle Video",
                click: ()=> toggleVideo(id, $btnVideo, $video, $nameLabel, stream)
            });
            const $btnAudio = $("<i>", {
                class: stream && stream.getAudioTracks()[0] && stream.getAudioTracks()[0].enabled
                    ? "bi bi-mic-fill" : "bi bi-mic-mute-fill text-danger",
                title:"Toggle Audio",
                click: ()=> toggleAudio(id, $btnAudio, stream)
            });
            const $btnFull = $("<i>", {class:"bi bi-arrows-fullscreen", title:"Fullscreen", click: ()=> $container[0].requestFullscreen()});
            const $btnLeave = $("<i>", {class:"bi bi-telephone-x-fill text-danger", title:"Leave Meeting", click: ()=> leaveMeeting(id)});

            $controls.append($btnVideo, $btnAudio, $btnFull, $btnLeave);
            $container.append($video, $nameLabel, $controls);
            $("#video-container").append($container);

            updateVideoVisibility(id, stream, $video, $nameLabel);
        }

        function updateVideoVisibility(id, stream, $video, $nameLabel){
            if(stream && stream.getVideoTracks()[0] && stream.getVideoTracks()[0].enabled){
                $video.show();
                $nameLabel.hide();
            } else {
                $video.hide();
                $nameLabel.text(id + " (Camera Off)").show();
            }
        }

        async function initMedia(){
            try {
                const videoEnabled = $("#videoOn").is(":checked");
                const audioEnabled = $("#audioOn").is(":checked");

                localStream = await navigator.mediaDevices.getUserMedia({
                    video: videoEnabled,
                    audio: audioEnabled
                });

                addVideoCard(username, localStream, true);
            } catch(err){
                alert("Error accessing camera/microphone: "+err);
            }
        }

        function toggleVideo(id, $btn, $video, $nameLabel, stream){
            if(id !== username || !stream) return;
            const videoTrack = stream.getVideoTracks()[0];

            if(videoTrack && videoTrack.enabled){
                videoTrack.stop();
                stream.removeTrack(videoTrack);
                $btn.attr("class", "bi bi-camera-video-off-fill text-danger");
                $video.hide();
                $nameLabel.text(id + " (Camera Off)").show();
            } else {
                navigator.mediaDevices.getUserMedia({video:true, audio:false})
                    .then(newStream => {
                        const newTrack = newStream.getVideoTracks()[0];
                        stream.addTrack(newTrack);
                        $video[0].srcObject = stream;
                        $btn.attr("class", "bi bi-camera-video-fill");
                        $video.show();
                        $nameLabel.hide();

                        Object.values(peers).forEach(pc => {
                            const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
                            if(sender) sender.replaceTrack(newTrack);
                        });
                    })
                    .catch(err => alert("Cannot access camera: " + err));
            }
        }

        function toggleAudio(id, $btn, stream){
            if(id === username && stream){
                const track = stream.getAudioTracks()[0];
                if(track){
                    track.enabled = !track.enabled;
                    $btn.attr("class", track.enabled ? "bi bi-mic-fill" : "bi bi-mic-mute-fill text-danger");
                }
            }
        }

        function leaveMeeting(id){
            if(id === username){
                if(ws) ws.send(JSON.stringify({type:"leave", meetingCode, fromId:username}));
                Object.values(peers).forEach(pc => pc.close());
                peers = {};
                $("#video-container").empty();
                if(localStream) localStream.getTracks().forEach(t => t.stop());
                localStream = null;
                alert("You have left the meeting.");
            } else {
                $("#" + id).remove();
                if(peers[id]) peers[id].close();
                delete peers[id];
            }
        }

        function addChatMessage(name, msg){
            $("#chat-box").append(`<p><b>${name}:</b> ${msg}</p>`).scrollTop($("#chat-box")[0].scrollHeight);
        }

        $("#joinBtn").click(async function(){
            meetingCode = $("#meetingCode").val().trim();
            username = $("#userName").val().trim();

            if(!meetingCode) return alert("Enter meeting code");
            if(!username) return alert("Enter your name");

            ws = new WebSocket("ws://localhost:8080/ws/signaling");
            ws.onopen = ()=> ws.send(JSON.stringify({type:"join", meetingCode, fromId:username, employeeName:username}));

            ws.onmessage = async (msg)=>{
                const data = JSON.parse(msg.data);
                const from = data.fromId;
                const type = data.type;

                if(type==="offer" && from!==username){
                    const pc = createPeerConnection(from);
                    await pc.setRemoteDescription(new RTCSessionDescription(data.payload));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    ws.send(JSON.stringify({type:"answer", meetingCode, fromId:username, toId:from, payload:answer}));
                } else if(type==="answer" && data.toId===username){
                    await peers[from].setRemoteDescription(new RTCSessionDescription(data.payload));
                } else if(type==="ice" && from!==username){
                    await peers[from].addIceCandidate(data.payload);
                } else if(type==="chat"){
                    addChatMessage(data.employeeName||from, data.message);
                }
            };

            await initMedia();
        });

        function createPeerConnection(peerId){
            const pc = new RTCPeerConnection();
            peers[peerId] = pc;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.onicecandidate = e=>{
                if(e.candidate){
                    ws.send(JSON.stringify({type:"ice", meetingCode, fromId:username, toId:peerId, payload:e.candidate}));
                }
            };

            pc.ontrack = e=> addVideoCard(peerId, e.streams[0]);

            pc.onnegotiationneeded = async ()=>{
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                ws.send(JSON.stringify({type:"offer", meetingCode, fromId:username, payload:offer}));
            };

            return pc;
        }

        $("#sendChat").click(function(){
            const msg = $("#chatInput").val().trim();
            if(msg && ws){
                ws.send(JSON.stringify({type:"chat", meetingCode, fromId:username, employeeName:username, message:msg}));
                addChatMessage("Me", msg);
                $("#chatInput").val("");
            }
        });
    });
</script>
</body>
</html>
