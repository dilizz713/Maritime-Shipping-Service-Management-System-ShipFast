<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Release Notes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { margin: 20px; }
        .table { font-size: 13px; }
        .btn { font-size: 13px; }
    </style>
</head>
<body>
<div class="container">
    <h3><i class="bi bi-file-text me-2"></i>Release Notes</h3>

    <!-- Search Provision -->
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" id="provisionRef" class="form-control" placeholder="Enter Provision Reference">
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary" id="searchBtn">
                <i class="bi bi-search me-1"></i> Search
            </button>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-bordered" id="releaseTable">
            <thead class="table-dark">
            <tr>
                <th>Product Code</th>
                <th>Product Name</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Provision Remark</th>
                <th>Stock Qty</th>
                <th>Release Remark</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button class="btn btn-success mt-3" id="saveBtn">
        <i class="bi bi-save me-1"></i> Save Release Notes
    </button>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function () {
        // Search provision
        $('#searchBtn').click(function () {
            let ref = $('#provisionRef').val();
            if (!ref) {
                alert("Enter provision reference!");
                return;
            }

            $.get(`http://localhost:8080/api/v1/release-notes/provision/${ref}`, function (items) {
                console.log("Fetched provision items:", items);
                let tbody = $('#releaseTable tbody');
                tbody.empty();

                if (items.length === 0) {
                    tbody.append(`<tr><td colspan="7" class="text-center">No items found.</td></tr>`);
                    return;
                }

                items.forEach(item => {
                    // Create the row as a jQuery object
                    let row = $(`
                        <tr data-id="${item.id}" data-product="${item.productId}">
                            <td>${item.productCode}</td>
                            <td>${item.productName}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unitPrice}</td>
                            <td>${item.remark || ''}</td>
                            <td><input type="number" class="form-control form-control-sm stockQty"></td>
                            <td><input type="text" class="form-control form-control-sm releaseRemark"></td>
                        </tr>
                    `);

                    tbody.append(row);

                    $.get(`http://localhost:8080/api/v1/product/${item.productId}/stock`, function (stockQty) {
                        row.find('.stockQty').val(stockQty);
                    });
                });
            }).fail(function () {
                alert("Provision not found!");
            });
        });

        // Save release notes
        // Save release notes
        $('#saveBtn').click(function () {
            let notes = [];
            $('#releaseTable tbody tr').each(function () {
                let provisionItemId = $(this).data('id');
                let productId = $(this).data('product');
                let remark = $(this).find('.releaseRemark').val();

                notes.push({
                    provisionItemId,
                    productId,
                    remark
                });
            });

            if (notes.length === 0) {
                alert("No items to save.");
                return;
            }

            $.ajax({
                url: "http://localhost:8080/api/v1/release-notes/save",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(notes),
                success: function () {
                    alert("Release notes saved successfully!");
                },
                error: function () {
                    alert("Error saving release notes.");
                }
            });
        });

    });
</script>
</body>
</html>
