<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f7fa;
            font-size: 0.875rem;
        }
        h1{
            font-size: 1.0rem;
        }
        h2{
            font-size: 0.975rem;
            padding: 5px;
        }
        #ship-logo {
            border-radius: 50%;
            border: 2px solid #fff;
            padding: 4px;
        }

        .company-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #003366;
            color: #fff;
        }
        .sidebar .nav-link {
            color: #fff;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #00509e;
            border-radius: 8px;
        }
        .sidebar .logo {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .navbar {
            background-color: #00509e;
        }
        .navbar .navbar-brand, .navbar .nav-link, .navbar .dropdown-toggle {
            color: #fff !important;
        }
        card {
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .card img {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .card-body .btn i {
            margin-right: 5px;
        }

        #previewImage {
            border-radius: 8px;
        }
        .card-body img:hover {
            transform: scale(1.05);
        }
        .meeting-btn {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #0066cc, #00bfff);
            color: #fff !important;
            border-radius: 8px;
            font-weight: 500;
        }

        .meeting-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            text-decoration: none;
            color: #fff !important;
        }

        /* Badge style */
        .meeting-btn .badge {
            font-size: 0.7rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar p-3">
        <div class="logo mb-4 text-center">
            <img src="../assets/ship%20logo.png" alt="ShipFast Logo" height="80" id="ship-logo" class="mb-2">
            <div class="company-name">Ship Fast</div>
        </div>
        <ul class="nav flex-column">
            <!-- Meetings -->
            <li class="nav-item mb-2">
                <a href="#" class="nav-link d-flex align-items-center justify-content-between meeting-btn" data-bs-toggle="modal" data-bs-target="#meetingModal">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-camera-video-fill me-2"></i>Meetings
                    </div>
                    <span class="badge bg-success rounded-pill">Live</span>
                </a>
            </li>

            <!-- Dashboard -->
            <li class="nav-item mb-2">
                <a href="admin-dashboard.html" class="nav-link "><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
            </li>
            <!-- Customer -->
            <li class="nav-item mb-2">
                <a href="customer-management.html" class="nav-link"><i class="bi bi-people me-2"></i>Customer</a>
            </li>
            <!-- Services -->
            <li class="nav-item mb-2">
                <a href="service-management.html" class="nav-link">
                    <i class="bi bi-gear me-2"></i>Services
                </a>
            </li>

            <!-- Inventory -->
            <li class="nav-item mb-2">
                <a href="inventory-management.html" class="nav-link">
                    <i class="bi bi-box-seam me-2"></i>Inventory
                </a>
            </li>

            <li class="nav-item mb-2">
                <a href="employee.html" class="nav-link">
                    <i class="bi bi-person-badge me-2"></i>Employee
                </a>
            </li>

            <!-- Vehicle -->
            <li class="nav-item mb-2">
                <a href="vehicle.html" class="nav-link">
                    <i class="bi bi-truck me-2"></i>Vehicle
                </a>
            </li>

            <!-- Request Services -->
            <li class="nav-item mb-2">
                <a href="request-services.html" class="nav-link">
                    <i class="bi bi-card-checklist me-2"></i>Request Services
                </a>
            </li>

            <li class="nav-item mb-2">
                <a class="nav-link" data-bs-toggle="collapse" href="#jobMenu" role="button" aria-expanded="false" aria-controls="jobMenu">
                    <i class="bi bi-briefcase me-2"></i>Job
                </a>
                <div class="collapse ps-4" id="jobMenu">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a href="#" class="nav-link">Job Manage</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Quotation</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Pending PO</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Job Schedule</a></li>
                        <li class="nav-item"><a href="#" class="nav-link">Delivery Note</a></li>
                    </ul>
                </div>
            </li>
            <li class="nav-item mb-2 costing-btn">
                <a href="#" class="nav-link"><i class="bi bi-cash-coin me-2"></i>Costing</a>
            </li>
            <li class="nav-item mb-2 user-btn">
                <a href="user-management.html" class="nav-link"><i class="bi bi-person-circle me-2"></i>User</a>
            </li>
        </ul>
    </div>

    <!-- Meeting Modal -->
    <div class="modal fade" id="meetingModal" tabindex="-1" aria-labelledby="meetingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="meetingModalLabel"><i class="bi bi-camera-video-fill me-2"></i>Meetings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">Choose an option to get started</p>
                    <div class="d-grid gap-3 mt-3">
                        <a href="create.html" class="btn btn-primary btn-lg rounded-pill">
                            <i class="bi bi-plus-circle me-2"></i> Create New Meeting
                        </a>
                        <a href="meeting.html" class="btn btn-outline-primary btn-lg rounded-pill">
                            <i class="bi bi-box-arrow-in-right me-2"></i> Join Meeting
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="flex-grow-1">
        <nav class="navbar navbar-expand-lg px-3">
            <div class="container-fluid justify-content-end">
                <div class="dropdown">
                    <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle me-2"></i>
                        <span id="user-info">Loading...</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                        <li><a class="dropdown-item" href="#">Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container my-5">
            <h2 class="text-center mb-4">Vehicle Management</h2>

            <!-- Add / Update Vehicle Form -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <span id="formTitle">Add Vehicle</span>
                </div>
                <div class="card-body">
                    <form id="vehicleForm" enctype="multipart/form-data">
                        <input type="hidden" id="vehicleId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Vehicle Name</label>
                                <input type="text" id="name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="numberPlate" class="form-label">Number Plate</label>
                                <input type="text" id="numberPlate" class="form-control" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="type" class="form-label">Type</label>
                                <input type="text" id="type" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label for="model" class="form-label">Model</label>
                                <input type="text" id="model" class="form-control" required>
                            </div>
                            <div class="col-md-4">
                                <label for="status" class="form-label">Status</label>
                                <select id="status" class="form-select">
                                    <option value="Available">Available</option>
                                    <option value="Unavailable">Unavailable</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="image" class="form-label">Vehicle Image</label>
                            <input type="file" id="image" class="form-control">
                            <img id="previewImage" src="" alt="Preview" class="img-fluid mt-2" style="max-height: 150px; display:none;">
                        </div>

                        <button type="submit" class="btn btn-success" id="submitBtn">Add Vehicle</button>
                        <button type="button" class="btn btn-secondary" id="cancelBtn" style="display:none;">Cancel</button>
                    </form>
                </div>
            </div>


            <div class="row" id="vehicleCards">

            </div>
        </div>
    </div>
</div>

<script src="../lib/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/navigation-bar.js"></script>
<script>

    const apiUrl = "http://localhost:8080/api/v1/vehicles";
    let editVehicleId = null;

    // ======================= LOAD VEHICLES =======================
    function loadVehicles() {
        $.get(`${apiUrl}/all`, function(res) {
            // Remove res.success check since backend doesn't have it
            if (Array.isArray(res.data)) {
                const container = $("#vehicleCards");
                container.empty();

                res.data.forEach(vehicle => {
                    const imgSrc = vehicle.image ? `http://localhost:8080/${vehicle.image}` : 'https://via.placeholder.com/300x200';

                    console.log(vehicle.image);
                    const card = $(`
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm">
                            <img src="${imgSrc}" class="card-img-top" style="height:200px; object-fit:cover;">
                            <div class="card-body">
                                <h5 class="card-title">${vehicle.name}</h5>
                                <p class="card-text">
                                    <strong>Number Plate:</strong> ${vehicle.numberPlate}<br>
                                    <strong>Type:</strong> ${vehicle.type}<br>
                                    <strong>Model:</strong> ${vehicle.model}<br>
                                    <strong>Status:</strong> <span class="badge ${vehicle.status === 'Available' ? 'bg-success' : 'bg-danger'}">${vehicle.status}</span>
                                </p>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-sm btn-primary me-2 edit-btn" data-id="${vehicle.id}">
                                        <i class="bi bi-pencil-square"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-btn" data-id="${vehicle.id}">
                                        <i class="bi bi-trash"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                    container.append(card);
                });
            } else {
                alert("Failed to load vehicles: " + res.message);
            }
        }).fail(function(xhr, status, error) {
            console.error("AJAX error:", error);
            alert("Failed to load vehicles due to server error");
        });
    }

    // ======================= ADD / UPDATE VEHICLE =======================
    $("#vehicleForm").submit(function(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append("name", $("#name").val());
        formData.append("numberPlate", $("#numberPlate").val());
        formData.append("type", $("#type").val());
        formData.append("model", $("#model").val());
        formData.append("status", $("#status").val());

        const imageFile = $("#image")[0].files[0];
        if (imageFile) formData.append("image", imageFile);

        let url = apiUrl + "/add";
        let method = "POST";

        if (editVehicleId) {
            url = `${apiUrl}/update/${editVehicleId}`;
            method = "PUT";
        }

        $.ajax({
            url: url,
            type: method,
            data: formData,
            contentType: false,
            processData: false,
            success: function(res) {
                alert(res.message);
                $("#vehicleForm")[0].reset();
                $("#previewImage").hide();
                $("#formTitle").text("Add Vehicle");
                $("#submitBtn").text("Add Vehicle");
                $("#cancelBtn").hide();
                editVehicleId = null;
                loadVehicles();
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                alert("Failed to save vehicle.");
            }
        });
    });

    // ======================= IMAGE PREVIEW =======================
    $("#image").on("change", function() {
        const file = this.files[0];
        if(file){
            $("#previewImage").attr("src", URL.createObjectURL(file)).show();
        } else {
            $("#previewImage").hide();
        }
    });

    // ======================= EDIT VEHICLE =======================
    $(document).on("click", ".edit-btn", function() {
        editVehicleId = $(this).data("id");

        $.get(`${apiUrl}/${editVehicleId}`, function(res) {
            if(res.data) { // Use res.data instead of res.success
                const v = res.data;
                $("#name").val(v.name);
                $("#numberPlate").val(v.numberPlate);
                $("#type").val(v.type);
                $("#model").val(v.model);
                $("#status").val(v.status);

                if (v.image) {
                    $("#previewImage").attr("src", `http://localhost:8080/${v.image}`).show();
                } else {
                    $("#previewImage").hide();
                }

                $("#formTitle").text("Edit Vehicle");
                $("#submitBtn").text("Update Vehicle");
                $("#cancelBtn").show();
            } else {
                alert("Failed to load vehicle data");
            }
        });
    });

    // ======================= CANCEL EDIT =======================
    $("#cancelBtn").click(function() {
        $("#vehicleForm")[0].reset();
        $("#previewImage").hide();
        $("#formTitle").text("Add Vehicle");
        $("#submitBtn").text("Add Vehicle");
        $(this).hide();
        editVehicleId = null;
    });

    // ======================= DELETE VEHICLE =======================
    $(document).on("click", ".delete-btn", function() {
        const id = $(this).data("id");
        if(confirm("Are you sure you want to delete this vehicle?")) {
            $.ajax({
                url: `${apiUrl}/delete/${id}`,
                type: "DELETE",
                success: function(res) {
                    alert(res.message);
                    loadVehicles();
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    alert("Failed to delete vehicle.");
                }
            });
        }
    });

    // ======================= INITIAL LOAD =======================
    $(document).ready(function() {
        $('#meetingModal .btn').click(function() {
            const action = $(this).text().trim();
            console.log("User selected:", action);
            $('#meetingModal').modal('hide'); // Close modal after selection
        });

        loadVehicles();
        $("#cancelBtn").hide();
    });


</script>
</body>
</html>
