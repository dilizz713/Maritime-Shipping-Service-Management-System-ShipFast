<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Goods Received Note (GRN)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body { font-size: 0.875rem; }
        .card { border-radius: 0.5rem; }
        .form-label { font-size: 0.8rem; color: #6c757d; }
        .fw-data { font-weight: 600; font-size: 0.9rem; color: #212529; }
        .table td, .table th { vertical-align: middle; font-size: 0.85rem; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .amount { font-weight: 600; }
        .badge-primary { background-color: #0d6efd; }
        #actionButtons button { min-width: 120px; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">

    <h3 class="mb-4"><i class="bi bi-receipt"></i> Goods Received Note (GRN)</h3>

    <div class="card mb-3 p-3 shadow-sm">
        <div class="row g-2 align-items-center">
            <div class="col-md-6">
                <input type="text" id="billNumber" class="form-control form-control-sm" placeholder="Enter Bill Number (e.g. 20230913-001)">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary btn-sm" id="searchBtn"><i class="bi bi-search"></i> Search</button>
            </div>
        </div>
    </div>

    <div id="grnDetails" class="card p-3 shadow-sm d-none">
        <h5><i class="bi bi-info-circle"></i> GRN Information</h5>
        <div class="row mb-2">
            <div class="col-md-4">
                <label class="form-label">GRN Number</label>
                <div class="fw-data" id="grnNumber"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Bill Number</label>
                <div class="fw-data badge bg-primary" id="billNumDisplay"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Vendor</label>
                <div class="fw-data" id="vendorName"></div>
            </div>
        </div>
        <div class="row mb-2">
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-calendar-event"></i> Received Date</label>
                <div class="fw-data" id="receivedDate"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label"><i class="bi bi-currency-dollar"></i> Total Amount</label>
                <div class="fw-data" id="totalAmount"></div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Remark</label>
                <input type="text" id="remark" class="form-control form-control-sm">
            </div>
        </div>
    </div>

    <div id="grnItemsContainer" class="card mt-3 p-3 shadow-sm d-none">
        <h5><i class="bi bi-box-seam"></i> GRN Items</h5>
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm align-middle" id="grnItemsTable">
                <thead class="table-dark">
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>UOM</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Discount</th>
                    <th>Amount</th>
                    <th>Description</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="mt-3 d-none" id="actionButtons">
        <button class="btn btn-success btn-sm" id="updateBtn"><i class="bi bi-save"></i> Update GRN</button>
        <button class="btn btn-secondary btn-sm" id="printBtn"><i class="bi bi-printer"></i> Print</button>
    </div>
</div>

<script>
    let currentGRN = null;


    $("#searchBtn").click(function () {
        const billNumber = $("#billNumber").val().trim();
        if (!billNumber) { alert("Please enter a Bill Number"); return; }

        $.ajax({
            url: `http://localhost:8080/api/v1/grn/by-bill/${billNumber}`,
            method: "GET",
            success: function (data) {
                currentGRN = data;
                $("#grnDetails, #grnItemsContainer, #actionButtons").removeClass("d-none");


                $("#grnNumber").text(data.grnNumber);
                $("#billNumDisplay").text(data.billNumber);
                $("#vendorName").text(data.vendorName);
                $("#receivedDate").text(data.receivedDate);
                $("#totalAmount").text(data.totalAmount.toFixed(2));
                $("#remark").val(data.remark || '');


                let rows = "";
                data.items.forEach(item => {
                    rows += `<tr data-id="${item.id}">
                        <td>${item.productCode}</td>
                        <td>${item.productName}</td>
                        <td>${item.productType}</td>
                        <td>${item.uom}</td>
                        <td><input type="number" class="form-control form-control-sm qty" value="${item.qty}"></td>
                        <td><input type="number" class="form-control form-control-sm unitPrice" value="${item.unitPrice}"></td>
                        <td><input type="number" class="form-control form-control-sm discount" value="${item.discount}"></td>
                        <td class="amount">${item.amount.toFixed(2)}</td>
                        <td><input type="text" class="form-control form-control-sm desc" value="${item.description || ''}"></td>
                    </tr>`;
                });
                $("#grnItemsTable tbody").html(rows);


                $("#grnItemsTable tbody tr").each(function () {
                    $(this).find(".qty, .unitPrice, .discount").on("input", function () {
                        const row = $(this).closest("tr");
                        const qty = parseFloat(row.find(".qty").val()) || 0;
                        const unitPrice = parseFloat(row.find(".unitPrice").val()) || 0;
                        const discount = parseFloat(row.find(".discount").val()) || 0;
                        const amount = (qty * unitPrice) - discount;
                        row.find(".amount").text(amount.toFixed(2));

                        // Update total
                        let total = 0;
                        $("#grnItemsTable tbody tr").each(function () {
                            total += parseFloat($(this).find(".amount").text()) || 0;
                        });
                        $("#totalAmount").text(total.toFixed(2));
                    });
                });
            },
            error: function () {
                alert("GRN not found for Bill Number: " + billNumber);
                $("#grnDetails, #grnItemsContainer, #actionButtons").addClass("d-none");
            }
        });
    });

    // Update GRN
    $("#updateBtn").click(function () {
        if (!currentGRN) return;

        let updatedItems = [];
        $("#grnItemsTable tbody tr").each(function () {
            const row = $(this);
            updatedItems.push({
                id: row.data("id"),
                qty: parseInt(row.find(".qty").val()) || 0,
                unitPrice: parseFloat(row.find(".unitPrice").val()) || 0,
                discount: parseFloat(row.find(".discount").val()) || 0,
                amount: parseFloat(row.find(".amount").text()) || 0,
                description: row.find(".desc").val()
            });
        });

        const updatedGRN = {
            id: currentGRN.id,
            remark: $("#remark").val(),
            items: updatedItems
        };

        $.ajax({
            url: "http://localhost:8080/api/v1/grn/update",
            method: "PUT",
            contentType: "application/json",
            data: JSON.stringify(updatedGRN),
            success: function () { alert("GRN updated successfully!"); },
            error: function (xhr) { alert("Error updating GRN: " + xhr.responseText); }
        });
    });


    $("#printBtn").click(function () {
        window.print();
    });

</script>

</body>
</html>
