<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirm Quotation - Ship Fast</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', sans-serif;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .card-header {
            font-weight: 600;
            letter-spacing: 0.5px;
            background-color: #0d6efd;
            color: #fff;
        }
        table th, table td {
            vertical-align: middle;
        }
        .form-control:focus {
            box-shadow: none;
            border-color: #0d6efd;
        }
        .btn-confirm {
            background-color: #198754;
            color: #fff;
            font-weight: 600;
        }
        .btn-confirm:hover {
            background-color: #157347;
            color: #fff;
        }
    </style>
</head>
<body>
<div class="container my-5">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Confirm Quotation</h5>
            <span id="vendorName" class="fw-bold"></span>
        </div>
        <div class="card-body">
            <div class="mb-3 row">
                <label class="col-sm-2 col-form-label fw-bold">Reference No:</label>
                <div class="col-sm-4">
                    <input type="text" id="refNumber" class="form-control" readonly>
                </div>
                <label class="col-sm-2 col-form-label fw-bold">Bill Number:</label>
                <div class="col-sm-4">
                    <input type="text" id="billNumber" class="form-control">
                </div>
            </div>

            <table class="table table-bordered table-striped align-middle" id="quotationTable">
                <thead class="table-dark">
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Discount (%)</th>
                    <th>Amount</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="d-flex justify-content-end mt-3">
                <h5 class="me-3">Total: <span id="totalAmount">0.00</span></h5>
                <button class="btn btn-confirm" id="confirmQuotation"><i class="bi bi-check-circle me-2"></i>Confirm Quotation</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    const API_URL = "http://localhost:8080/api/v1";
    let inquiryId = 1;
    let inquiryData = null;

    // Load inquiry and items
    function loadInquiry() {
        $.get(`${API_URL}/inquiries/${inquiryId}`, function(data){
            inquiryData = data;
            $("#refNumber").val(data.referenceNumber);
            $("#vendorName").text(data.vendorName);
            const tbody = $("#quotationTable tbody");
            tbody.empty();
            data.items.forEach(item => {
                tbody.append(`
                <tr data-item-id="${item.id}">
                    <td>${item.productName}</td>
                    <td><input type="number" class="form-control quantity" value="${item.quantity}" readonly></td>
                    <td><input type="number" class="form-control unitPrice" value="${item.unitPrice || 0}"></td>
                    <td><input type="number" class="form-control discount" value="0"></td>
                    <td class="amountCell">${item.unitPrice || 0}</td>
                </tr>
            `);
            });
            calculateTotal();
        });
    }

    // Calculate amount per row and total
    function calculateTotal() {
        let total = 0;
        $("#quotationTable tbody tr").each(function(){
            const unitPrice = parseFloat($(this).find(".unitPrice").val()) || 0;
            const quantity = parseInt($(this).find(".quantity").val()) || 0;
            const discount = parseFloat($(this).find(".discount").val()) || 0;
            const amount = quantity * unitPrice * (1 - discount/100);
            $(this).find(".amountCell").text(amount.toFixed(2));
            total += amount;
        });
        $("#totalAmount").text(total.toFixed(2));
    }

    // Listen to changes in unit price or discount
    $(document).on("input", ".unitPrice, .discount", calculateTotal);

    // Confirm quotation
    $("#confirmQuotation").click(function(){
        const billNumber = $("#billNumber").val().trim();
        if(!billNumber){
            alert("Please enter bill number!");
            return;
        }
        const items = [];
        $("#quotationTable tbody tr").each(function(){
            const itemId = $(this).data("item-id");
            const discount = parseFloat($(this).find(".discount").val()) || 0;
            const amount = parseFloat($(this).find(".amountCell").text()) || 0;
            items.push({ itemId, discount, amount });
        });

        const quotationDTO = {
            inquiryId,
            billNumber,
            totalAmount: parseFloat($("#totalAmount").text()),
            items
        };

        $.ajax({
            url: `${API_URL}/vendor-quotations/confirm`,
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(quotationDTO),
            success: function(){
                alert("Quotation confirmed successfully!");
                // Optionally redirect or refresh page
            },
            error: function(err){
                console.error(err);
                alert("Failed to confirm quotation.");
            }
        });
    });

    // Initialize
    loadInquiry();
</script>
</body>
</html>
